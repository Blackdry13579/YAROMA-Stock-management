<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique - YAROMA Service</title>
    
    <link rel="icon" type="image/png" href="../assets/img/logo.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        .timeline-item {
            display: flex;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
            transition: background var(--transition-fast);
        }

        .timeline-item:hover {
            background: var(--gray-50);
        }

        .timeline-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .timeline-icon.sale {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .timeline-icon.purchase {
            background: rgba(79, 107, 255, 0.1);
            color: var(--primary-color);
        }

        .timeline-icon.stock {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-xs);
        }

        .timeline-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .timeline-description {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
        }

        .timeline-time {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
        }

        .timeline-amount {
            font-weight: 600;
            font-size: var(--font-size-lg);
        }

        .timeline-amount.positive {
            color: var(--success);
        }

        .timeline-amount.negative {
            color: var(--error);
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                </div>
                <div class="sidebar-brand">
                    <h1>YAROMA</h1>
                    <p>Gestion de Stock</p>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h3 class="nav-section-title">Principal</h3>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="dashboard.html" class="nav-link">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                    <rect x="3" y="14" width="7" height="7"></rect>
                                </svg>
                                Dashboard
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <h3 class="nav-section-title">Gestion</h3>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="products/list.html" class="nav-link">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                </svg>
                                Produits
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="categories/list.html" class="nav-link">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"></path>
                                </svg>
                                Catégories
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="inventory/list.html" class="nav-link">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path>
                                    <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path>
                                    <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>
                                </svg>
                                Stock
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <h3 class="nav-section-title">Opérations</h3>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="sales/list.html" class="nav-link">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="21" r="1"></circle>
                                    <circle cx="20" cy="21" r="1"></circle>
                                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                </svg>
                                Ventes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="purchases/list.html" class="nav-link">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                                    <rect x="2" y="9" width="4" height="12"></rect>
                                    <circle cx="4" cy="4" r="2"></circle>
                                </svg>
                                Ravitaillement
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="history.html" class="nav-link active">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                Historique
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <h3 class="nav-section-title">Contacts</h3>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link disabled" onclick="return false;">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                </svg>
                                Fournisseurs
                                <span class="nav-badge" style="background: var(--gray-400);">Bientôt</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link disabled" onclick="return false;">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                </svg>
                                Clients
                                <span class="nav-badge" style="background: var(--gray-400);">Bientôt</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <h3 class="nav-section-title">Système</h3>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="settings.html" class="nav-link">
                                <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6"></path>
                                </svg>
                                Paramètres
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-user" onclick="handleLogout()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Chargement...</div>
                        <div class="user-role" id="userRole">Admin</div>
                    </div>
                    <svg class="user-logout" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </div>
            </div>
        </aside>

        <!-- Contenu principal -->
        <main class="main-content" id="mainContent">
            <header class="main-header">
                <div class="header-left">
                    <button class="header-toggle" onclick="toggleSidebar()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="header-title">
                        <h1>Historique</h1>
                        <p>Historique complet de toutes les opérations</p>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <!-- Filtres -->
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card-body" style="padding: var(--spacing-lg);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                            <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
                                <input type="date" id="startDate" class="form-input" style="width: 180px;">
                                <input type="date" id="endDate" class="form-input" style="width: 180px;">
                                <select id="typeFilter" class="form-select" style="width: 200px;" onchange="filterHistory()">
                                    <option value="">Toutes les opérations</option>
                                    <option value="sale">Ventes</option>
                                    <option value="purchase">Achats</option>
                                    <option value="stock">Mouvements de stock</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: var(--spacing-md);">
                                <button class="btn btn-outline" onclick="filterByDate()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 3h18v18H3zM21 9H3M21 15H3"></path>
                                    </svg>
                                    Filtrer
                                </button>
                                <button class="btn btn-outline" onclick="resetFilters()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                                        <path d="M21 3v5h-5M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                                        <path d="M3 21v-5h5"></path>
                                    </svg>
                                    Réinitialiser
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Timeline des opérations
                        </h2>
                        <span id="historyCount" class="badge badge-primary">0 opérations</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="historyTimeline">
                            <div style="text-align: center; padding: var(--spacing-xl);">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/services/odoo-api.js"></script>
    <script src="../js/services/auth.js"></script>
    <script src="../js/app.js"></script>
    <script>
        let allHistory = [];
        let filteredHistory = [];

        // Données de test combinées
        const testHistory = [
            { id: 1, type: 'sale', date: '2024-12-26T14:30:00', title: 'Vente #V0001', description: 'Vente à Jean Dupont - 5 articles', amount: 125000, positive: true },
            { id: 2, type: 'purchase', date: '2024-12-26T10:15:00', title: 'Achat #A0001', description: 'Achat de Rail +couvre (Argent/Champagne) - 20 unités', amount: 270000, positive: false },
            { id: 3, type: 'sale', date: '2024-12-25T16:45:00', title: 'Vente #V0002', description: 'Vente à Marie Martin - 3 articles', amount: 75000, positive: true },
            { id: 4, type: 'purchase', date: '2024-12-25T11:20:00', title: 'Achat #A0002', description: 'Achat de F-Glass (Blanc/Noir) - 15 unités', amount: 67500, positive: false },
            { id: 5, type: 'stock', date: '2024-12-25T09:00:00', title: 'Mouvement de stock', description: 'Ajustement stock - Cornière léger (40)', amount: null, positive: null },
            { id: 6, type: 'sale', date: '2024-12-24T15:30:00', title: 'Vente #V0003', description: 'Vente à Sophie Bernard - 2 articles', amount: 45000, positive: true },
            { id: 7, type: 'purchase', date: '2024-12-24T08:45:00', title: 'Achat #A0003', description: 'Achat de Cornière léger (40) - 10 unités', amount: 150000, positive: false },
        ];

        async function initHistoryPage() {
            try {
                if (!window.AuthService || !window.AuthService.isAuthenticated()) {
                    window.location.href = 'auth/login.html';
                    return;
                }

                const user = window.AuthService.getCurrentUser();
                if (user) {
                    document.getElementById('userName').textContent = user.fullname;
                    document.getElementById('userAvatar').textContent = user.fullname.charAt(0).toUpperCase();
                }

                // Dates par défaut (7 derniers jours)
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                
                document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];
                document.getElementById('endDate').value = today.toISOString().split('T')[0];

                loadHistory();
            } catch (error) {
                console.error('Erreur initialisation:', error);
            }
        }

        function loadHistory() {
            allHistory = [...testHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredHistory = [...allHistory];
            displayHistory();
        }

        function displayHistory() {
            const container = document.getElementById('historyTimeline');
            document.getElementById('historyCount').textContent = `${filteredHistory.length} opérations`;

            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <h3 class="empty-state-title">Aucune opération</h3>
                        <p class="empty-state-message">Aucune opération trouvée pour cette période</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredHistory.map(item => {
                const date = new Date(item.date);
                const timeStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }) + ' à ' + 
                               date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                const iconConfig = {
                    sale: {
                        class: 'sale',
                        icon: '<circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>'
                    },
                    purchase: {
                        class: 'purchase',
                        icon: '<path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>'
                    },
                    stock: {
                        class: 'stock',
                        icon: '<path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>'
                    }
                };

                const config = iconConfig[item.type];
                const amountHTML = item.amount !== null ? `
                    <div class="timeline-amount ${item.positive ? 'positive' : 'negative'}">
                        ${item.positive ? '+' : '-'} ${item.amount.toLocaleString()} XOF
                    </div>
                ` : '';

                return `
                    <div class="timeline-item">
                        <div class="timeline-icon ${config.class}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${config.icon}
                            </svg>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <div>
                                    <div class="timeline-title">${item.title}</div>
                                    <div class="timeline-description">${item.description}</div>
                                    <div class="timeline-time">${timeStr}</div>
                                </div>
                                ${amountHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Veuillez sélectionner les dates de début et de fin');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59);

            filteredHistory = allHistory.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= start && itemDate <= end;
            });

            filterHistory();
        }

        function filterHistory() {
            const typeFilter = document.getElementById('typeFilter').value;

            let history = [...filteredHistory];

            if (typeFilter) {
                history = history.filter(item => item.type === typeFilter);
            }

            filteredHistory = history;
            displayHistory();
        }

        function resetFilters() {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('typeFilter').value = '';
            
            filteredHistory = [...allHistory];
            displayHistory();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function handleLogout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                window.AuthService.logout();
            }
        }

        window.addEventListener('DOMContentLoaded', initHistoryPage);
    </script>
</body>
</html>